<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfiguration bearbeiten</title>
    <script>
        // Funktion zum Laden der Konfigurationsdaten
        async function loadConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const configPath = urlParams.get("configPath");

            if (!configPath) {
                alert("Kein Konfigurationspfad angegeben.");
                return;
            }

            try {
                const response = await fetch(`/get-config?configPath=${encodeURIComponent(configPath)}`);
                const data = await response.json();

                if (!data.success) {
                    alert(data.error || "Fehler beim Laden der Konfiguration.");
                    return;
                }

                // Fülle die Konfigurationsfelder
                const configFieldsDiv = document.getElementById("configFields");
                configFieldsDiv.innerHTML = "";

                for (const [key, value] of Object.entries(data.config.pcb2gcode || {})) {
                    addConfigField(key, value);
                }

                // Setze den versteckten configPath-Wert
                document.getElementById("configPath").value = configPath;
            } catch (error) {
                console.error("Fehler beim Laden der Konfiguration:", error);
                alert("Fehler beim Laden der Konfiguration.");
            }
        }

        // Funktion zum Hinzufügen eines neuen Konfigurationsfeldes
        function addConfigField(key = "", value = "") {
            const configFieldsDiv = document.getElementById("configFields");

            const field = document.createElement("div");
            field.className = "configField";
            field.innerHTML = `
                <button type="button" onclick="removeConfigField(this)">-</button>
                <label>${key}</label>
                <input type="text" name="${key}" value="${value}" />
            `;
            configFieldsDiv.appendChild(field);
        }

        // Funktion zum Entfernen eines Konfigurationsfeldes
        function removeConfigField(button) {
            const field = button.parentElement;
            field.remove();
        }

        // Funktion zum Hinzufügen eines neuen Parameters über den "+"-Button
        function addNewParameter() {
            const newKeyInput = document.getElementById("newKey");
            const newValueInput = document.getElementById("newValue");

            const newKey = newKeyInput.value.trim();
            const newValue = newValueInput.value.trim();

            if (!newKey) {
                alert("Bitte geben Sie einen Parameternamen ein.");
                return;
            }

            addConfigField(newKey, newValue);

            // Leere die Eingabefelder
            newKeyInput.value = "";
            newValueInput.value = "";
        }

        // Lade die Konfiguration beim Laden der Seite
        window.addEventListener("DOMContentLoaded", loadConfig);
    </script>
</head>
<body>
    <h1>Bearbeite config.json</h1>
  <form action="/save-config" method="post">
        <input type="hidden" name="configPath" id="configPath" />
        <div id="configFields">
            <!-- Dynamische Konfigurationsfelder werden hier eingefügt -->
        </div>
        <div>
          <button type="button" onclick="addNewParameter()">+</button>
          <input type="text" name="newKey" id="newKey" placeholder="Parametername" />
          <input type="text" name="newValue" id="newValue" placeholder="Wert" />
      </div>
            <button type="submit">Speichern</button>
    </form>
    <a href="/">Zurück</a>
</body>
</html>